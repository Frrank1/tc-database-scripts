SELECT COUNT(*) AS cnt
  FROM  table(multiset(
    SELECT p.project_id AS contest_id
    , (SELECT COUNT(*) FROM upload u, submission s
       WHERE u.project_id = p.project_id AND s.upload_id = u.upload_id
       AND s.submission_type_id = 1 AND s.placement IS NOT NULL) AS winner_count
    FROM project p
    INNER JOIN project_category_lu pcl ON p.project_category_id = pcl.project_category_id
    INNER JOIN project_phase ppr ON p.project_id = ppr.project_id AND ppr.phase_type_id = 1
    INNER JOIN project_phase pps ON p.project_id = pps.project_id AND pps.phase_type_id = 2
    WHERE p.project_status_id IN (1, 7, 9, 4, 10)
    AND   pcl.project_type_id = 3
    AND   ppr.phase_status_id = 3 
    AND   pps.phase_status_id = 3
    AND   pcl.project_category_id IN (@pcids@)
    AND   NVL(ppr.actual_start_time, pps.actual_start_time) >= '@sdt@'
    AND   NVL(ppr.actual_start_time, pps.actual_start_time) <= '@edt@'
    AND NOT EXISTS (SELECT 'has_eligibility_constraints' FROM contest_eligibility ce
        WHERE ce.is_studio = 0 AND ce.contest_id = p.project_id)
)) t
WHERE (@wc@ = -1 OR @wc@ = 0 OR winner_count BETWEEN 1 AND @wc@)

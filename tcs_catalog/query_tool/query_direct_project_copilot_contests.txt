select UNIQUE p.project_id as contest_id, tdp.project_id as tc_direct_project_id, tdp.name as tc_direct_project_name, 
(select value from project_info where project_id = p.project_id and project_info_type_id =6) as contest_name,
pcl.name as contest_type,

case when p.project_status_id != 1 then psl.name 
       when exists (select project_phase_id from project_phase where project_id = p.project_id and phase_type_id = 2 and phase_status_id = 1)
             and exists (select project_phase_id from project_phase where project_id = p.project_id and phase_type_id = 14 and phase_status_id = 3)
             and not exists (select project_phase_id from project_phase where project_id = p.project_id and phase_type_id in (13, 14)  and phase_status_id in (2,3))
           then 'Passed Spec Review'
       when p.project_status_id = 1 and not exists (select project_phase_id from project_phase where project_id = p.project_id and (phase_status_id = 2 or phase_status_id = 1))
           then 'Completed'
       when ptl.name is not null and p.project_status_id = 1 then ptl.name
       when sale.contest_sale_id is not null and p.project_status_id = 1 then 'Scheduled'
       else 'Draft' end as status,
p.project_status_id as status_id,
pcl.project_type_id == 3 as is_studio,
ri.value as copilot_user_id

from tc_direct_project tdp, user_permission_grant upg, 
project_category_lu pcl, project_status_lu psl, 

project p left outer join project_phase ph 
      on (p.project_id = ph.project_id and ph.project_phase_id = 
                                     (select min(project_phase_id) from project_phase  where phase_status_id = 2 and project_id=p.project_id))
left outer join phase_type_lu ptl on (ph.phase_type_id = ptl.phase_type_id)
left outer join contest_sale sale on (p.project_id = sale.contest_id and sale.contest_sale_id  = (select min(contest_sale_id) from contest_sale where contest_id = p.project_id))
inner join resource r on r.project_id = p.project_id and r.resource_role_id = 14
inner join resource_info ri on ri.resource_id = r.resource_id and ri.resource_info_type_id = 1

where tdp.project_id = upg.resource_id
and upg.user_id = @uid@
and upg.permission_type_id in (1,2,3)
and p.tc_direct_project_id = @tcdirectid@
and p.project_category_id = pcl.project_category_id 
and p.project_status_id = psl.project_status_id
and p.tc_direct_project_id = tdp.project_id
and p.project_status_id != 3 and p.project_category_id != 27

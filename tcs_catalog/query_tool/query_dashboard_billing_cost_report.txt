SELECT pm.create_date payment_date,
       p.project_id as contest_id,
       ttc.name client,	
       ttp.name billing_project_name,
       tdp.name direct_project_name,
       (select max (scheduled_start_time) from project_phase where phase_type_id = 1 and project_id = p.project_id) as launch_date,
       ct.completion_time completion_date,
       DECODE(pc.name, 'UI Prototype Competition', 'UI Prototype', 'Assembly Competition', 'Assembly', 'RIA Build Competition', 'RIA Build', 'Test Suites', 'Test Suites', 'Test Scenarios', 'Test Scenarios',  pc.name) category,
       pi.value as contest_name,
       CASE
       WHEN ps.project_status_id not in (1,2,3)
          THEN 'Finished'
       WHEN not exists(select actual_start_time from project_phase pp where pp.project_id = p.project_id and pp.phase_type_id = 1 and pp.actual_start_time <= current )
          THEN 'Scheduled'
       WHEN (select actual_start_time from project_phase pp where pp.project_id = p.project_id and pp.phase_type_id = 1 and pp.actual_start_time <= current ) <= current
          THEN 'Active'
       ELSE
          'Active'
       END as contest_status,

        case when p.project_status_id in (9, 10) and exists (select * from project_phase where project_id = p.project_id and phase_type_id = 1 and phase_status_id in (2,3))
            then pi2.value::DECIMAL(10,2)
            when p.project_status_id in (9, 10) and not exists (select * from project_phase where project_id = p.project_id and phase_type_id = 1 and phase_status_id in (2,3))
            then 0 
            else pi2.value::DECIMAL(10,2) end as contest_fee,

  SUM(case when p.project_status_id = 7 then
      NVL((SELECT sum(total_amount)
       FROM  informixoltp:payment_detail pmd, informixoltp:payment pm
        WHERE pmd.component_project_id = p.project_id and pmd.installment_number = 1
        and pm.most_recent_detail_id = pmd.payment_detail_id 
        AND NOT pmd.payment_status_id IN (65, 68, 69)), 0)
    +
    NVL((SELECT sum(pmd2.total_amount) 
           FROM  informixoltp:payment_detail pmd,  
                 informixoltp:payment pm LEFT OUTER JOIN informixoltp:payment_detail pmd2 on pm.payment_id = pmd2.parent_payment_id, 
                 informixoltp:payment pm2 
            WHERE pmd.component_project_id = p.project_id and pmd2.installment_number = 1 
            and pm.most_recent_detail_id = pmd.payment_detail_id  
            and pm2.most_recent_detail_id = pmd2.payment_detail_id 
            AND NOT pmd2.payment_status_id IN (65, 68, 69)), 0)
     +
    nvl((select nvl(sum (cast (nvl (pi30.value, '0') as DECIMAL (10,2))), 0) from project_info pi30, project_info pi26
        where pi30.project_info_type_id = 30 and pi26.project_info_type_id = 26 and pi26.project_id = pi30.project_id 
        and pi26.value = 'On'
        and pi26.project_id =  p.project_id ), 0)
  else NVL((SELECT sum(total_amount)
       FROM  informixoltp:payment_detail pmd, informixoltp:payment pm
        WHERE pmd.component_project_id = p.project_id and pmd.installment_number = 1
        and pm.most_recent_detail_id = pmd.payment_detail_id 
        AND NOT pmd.payment_status_id IN (65, 68, 69)), 0)
    +
    NVL((SELECT sum(pmd2.total_amount) 
           FROM  informixoltp:payment_detail pmd,  
                 informixoltp:payment pm LEFT OUTER JOIN informixoltp:payment_detail pmd2 on pm.payment_id = pmd2.parent_payment_id, 
                 informixoltp:payment pm2 
            WHERE pmd.component_project_id = p.project_id and pmd2.installment_number = 1 
            and pm.most_recent_detail_id = pmd.payment_detail_id  
            and pm2.most_recent_detail_id = pmd2.payment_detail_id 
            AND NOT pmd2.payment_status_id IN (65, 68, 69)), 0)
  end) as actual_total_member_costs,

       pt.payment_type_desc,
    CASE WHEN pmd.payment_type_id in (45,57)
         THEN 'Copilot'
         WHEN pmd.payment_type_id in (27)
         THEN 'Spec Review'
         WHEN pmd.payment_type_id in (6, 29, 10, 42, 43, 44, 49, 50, 51, 55, 61)
         THEN 'Prizes'
         WHEN pmd.payment_type_id in (7, 28, 26)
         THEN 'Review'
         WHEN pmd.payment_type_id in (24)
         THEN 'Reliability'
         WHEN pmd.payment_type_id in (4)
         THEN 'Referral'
         WHEN pmd.payment_type_id in (23,37,46,47)
         THEN 'Bugs'
         WHEN pmd.payment_type_id in (39)
         THEN 'Build'
         WHEN pmd.payment_type_id NOT in (39,23,37,46,47,45,57,4,24,27,7, 28, 26,6, 29, 10, 42, 43, 44, 49, 50, 51, 55, 61)
         THEN 'Misc'
         ELSE 'Not Sure'
    END as line_item_category,
    pmd.total_amount as line_item_amount,
     ttc.client_id,
ttp.project_id billing_project_id,
tdp.project_id direct_project_id,
nvl((select nvl(sum (cast (nvl (pi30.value, '0') as DECIMAL (10,2))), 0) from project_info pi30, project_info pi26
        where pi30.project_info_type_id = 30 and pi26.project_info_type_id = 26 and pi26.project_id = pi30.project_id 
        and pi26.value = 'On'
        and pi26.project_id =  p.project_id ), 0) as digital_run,
        p.project_category_id,
        pmd.payment_detail_id,    
        (NVL((SELECT sum(pmd.total_amount)
          FROM informixoltp:payment_detail pmd, informixoltp:payment pm
            WHERE pmd.component_project_id = p.project_id and pmd.installment_number = 1
            AND pm.most_recent_detail_id = pmd.payment_detail_id 
            AND NOT pmd.payment_status_id IN (65, 68, 69)
            AND pmd.payment_type_id in (24)), 0)
           +
           NVL((SELECT sum(pmd2.total_amount)
                  FROM informixoltp:payment_detail pmd,  
                       informixoltp:payment pm LEFT OUTER JOIN informixoltp:payment_detail pmd2 on pm.payment_id = pmd2.parent_payment_id, 
                       informixoltp:payment pm2 
                  WHERE pmd.component_project_id = p.project_id and pmd2.installment_number = 1 
                  AND pm.most_recent_detail_id = pmd.payment_detail_id  
                  AND pm2.most_recent_detail_id = pmd2.payment_detail_id 
                  AND pmd2.payment_type_id in (24)
                  AND NOT pmd2.payment_status_id IN (65, 68, 69)), 0)
           ) AS reliability,
          0 as is_studio
FROM informixoltp:payment pm INNER JOIN informixoltp:payment_detail pmd ON pm.most_recent_detail_id = pmd.payment_detail_id,
     informixoltp:payment_type_lu pt,
     project p,     
     tc_direct_project tdp,
     project_status_lu ps,
     project_category_lu pc,
     project_info pi, -- project name
     project_info pi2, -- contest_fee
     project_info pi3, -- billing account
     time_oltp:project ttp,
     time_oltp:client_project ttcp,
     time_oltp:client ttc,
     table (multiset((select  project_id, MAX(NVL(actual_end_time, scheduled_end_time)) as completion_time from project_phase where phase_type_id = 11 GROUP BY project_id))) ct
where  pmd.component_project_id = p.project_id
   and pmd.payment_type_id = pt.payment_type_id
   and installment_number = 1
   AND NOT pmd.payment_status_id IN (65,68, 69)
   and p.project_status_id = ps.project_status_id
  and p.project_category_id = pc.project_category_id
  and p.project_category_id IN (@pcids@) 
  and p.project_id = ct.project_id
  and p.project_id = pi.project_id
  and pi.project_info_type_id = 6
  and p.project_id = pi2.project_id
  and pi2.project_info_type_id = 31
  and p.project_id = pi3.project_id
  and pi3.project_info_type_id = 32
  and pi3.value = ttp.project_id
  and ttp.project_id = ttcp.project_id
  and ttcp.client_id = ttc.client_id
  and p.project_status_id != 3 and p.project_category_id != 27
  and ttc.client_id = DECODE(@clientid@, 0, ttc.client_id, @clientid@)
  and ttp.project_id = DECODE(@billingaccountid@, 0, ttp.project_id, @billingaccountid@)
  and p.tc_direct_project_id = tdp.project_id
  and tdp.project_id = DECODE(@tcdirectid@, 0, tdp.project_id, @tcdirectid@)
  and (pm.create_date BETWEEN TO_DATE('@sdt@ 00:00:00', '%Y-%m-%d %H:%M:%S') AND TO_DATE('@edt@ 23:59:59', '%Y-%m-%d %H:%M:%S'))
group by 1,2,3,4,5,6,7,8,9,10,11,13,14,15,16,17,18,19,20,21,22,23
 
UNION
 
select
pm.create_date payment_date,
c.contest_id as contest_id,
NVL(ttc.name, 'One-Off') client,
NVL(ttp.name, 'One-Off') billing_project_name,
NVL(tdp.name, 'One-Off') direct_project_name,
c.start_time launch_date,
c.end_time completion_date,
cc.contest_type_desc category,
c.name as contest_name,
DECODE(cds.contest_detailed_status_id, 2, 'Active', 5, 'Active', 6, 'Active', 10, 'Active', 9, 'Scheduled', 7, 'Finished', 8, 'Finished', cds.name) contest_status,
cc2.property_value::DECIMAL(10,2) as contest_fee,

case when c.contest_detailed_status_id = 8 then
    NVL((SELECT sum(total_amount)
       FROM  informixoltp:payment_detail pmd, informixoltp:payment pm
        WHERE pmd.studio_contest_id = c.contest_id and pmd.installment_number = 1
        and pm.most_recent_detail_id = pmd.payment_detail_id 
        AND NOT pmd.payment_status_id IN (65, 68, 69)), 0)
+
NVL((SELECT sum(pmd2.total_amount) 
       FROM  informixoltp:payment_detail pmd,  
             informixoltp:payment pm LEFT OUTER JOIN informixoltp:payment_detail pmd2 on pm.payment_id = pmd2.parent_payment_id, 
             informixoltp:payment pm2 
        WHERE pmd.studio_contest_id = c.contest_id and pmd2.installment_number = 1 
        and pm.most_recent_detail_id = pmd.payment_detail_id  
        and pm2.most_recent_detail_id = pmd2.payment_detail_id 
        AND NOT pmd2.payment_status_id IN (65, 68, 69)), 0)
     + 
     nvl((select (cast(nvl(property_value, '0') as DECIMAL(10,2)))
            from studio_oltp:contest_config cfg, studio_oltp:contest cc  
            where cfg.contest_id = cc.contest_id and property_id = 24
            and cfg.contest_id = c.contest_id), 0)
 else NVL((SELECT sum(total_amount)
       FROM  informixoltp:payment_detail pmd, informixoltp:payment pm
        WHERE pmd.studio_contest_id = c.contest_id and pmd.installment_number = 1
        and pm.most_recent_detail_id = pmd.payment_detail_id 
        AND NOT pmd.payment_status_id IN (65, 68, 69)), 0)
+
NVL((SELECT sum(pmd2.total_amount) 
       FROM  informixoltp:payment_detail pmd,  
             informixoltp:payment pm LEFT OUTER JOIN informixoltp:payment_detail pmd2 on pm.payment_id = pmd2.parent_payment_id, 
             informixoltp:payment pm2 
        WHERE pmd.studio_contest_id = c.contest_id and pmd2.installment_number = 1 
        and pm.most_recent_detail_id = pmd.payment_detail_id  
        and pm2.most_recent_detail_id = pmd2.payment_detail_id 
        AND NOT pmd2.payment_status_id IN (65, 68, 69)), 0)
end  as actual_total_member_costs,

    pt.payment_type_desc,
    CASE WHEN pmd.payment_type_id in (45,57)
         THEN 'Copilot'
         WHEN pmd.payment_type_id in (48)
         THEN 'Spec Review'
         WHEN pmd.payment_type_id in (13)
         THEN 'Prizes'
         WHEN pmd.payment_type_id in (56)
         THEN 'Review'
         WHEN pmd.payment_type_id in (24)
         THEN 'Reliability'
         WHEN pmd.payment_type_id in (4)
         THEN 'Referral'
         WHEN pmd.payment_type_id in (23,37,46,47)
         THEN 'Bugs'
         WHEN pmd.payment_type_id in (39)
         THEN 'Build'
         WHEN pmd.payment_type_id NOT in (45,57,48,13,56,24,4,23,37,46,47,39)
         THEN 'Misc'
         ELSE 'Not Sure'
    END as line_item_category,
    pmd.total_amount as line_item_amount,
    ttc.client_id,
    ttp.project_id billing_project_id,
    tdp.project_id direct_project_id,
nvl((select (cast(nvl(property_value, '0') as DECIMAL(10,2)))
            from studio_oltp:contest_config cfg, studio_oltp:contest cc  
            where cfg.contest_id = cc.contest_id and property_id = 24
            and cfg.contest_id = c.contest_id), 0) as digital_run,
    cc.contest_type_id project_category_id,
    pmd.payment_detail_id,
    (NVL((SELECT sum(pmd.total_amount)
          FROM informixoltp:payment_detail pmd, informixoltp:payment pm
            WHERE pmd.studio_contest_id = c.contest_id and pmd.installment_number = 1
            AND pm.most_recent_detail_id = pmd.payment_detail_id 
            AND NOT pmd.payment_status_id IN (65, 68, 69)
            AND pmd.payment_type_id in (24)), 0)
           +
           NVL((SELECT sum(pmd2.total_amount)
                  FROM informixoltp:payment_detail pmd,  
                       informixoltp:payment pm LEFT OUTER JOIN informixoltp:payment_detail pmd2 on pm.payment_id = pmd2.parent_payment_id, 
                       informixoltp:payment pm2 
                  WHERE pmd.studio_contest_id = c.contest_id and pmd2.installment_number = 1 
                  AND pm.most_recent_detail_id = pmd.payment_detail_id  
                  AND pm2.most_recent_detail_id = pmd2.payment_detail_id 
                  AND pmd2.payment_type_id in (24)
                  AND NOT pmd2.payment_status_id IN (65, 68, 69)), 0)
           ) AS reliability,
           1 as is_studio
FROM informixoltp:payment pm INNER JOIN informixoltp:payment_detail pmd ON pm.most_recent_detail_id = pmd.payment_detail_id,
     informixoltp:payment_type_lu pt,
     studio_oltp:contest c,
     studio_oltp:contest_config cc1, studio_oltp:contest_config cc2, time_oltp:project ttp, time_oltp:client_project ttcp, time_oltp:client ttc,
     tc_direct_project tdp,
     studio_oltp:contest_type_lu cc,
     studio_oltp:contest_status_lu cs,
     studio_oltp:contest_detailed_status_lu cds
where pmd.studio_contest_id = c.contest_id
   and pmd.payment_type_id = pt.payment_type_id
   and installment_number = 1
   AND NOT pmd.payment_status_id IN (65,68, 69)
  and cds.contest_detailed_status_id IN (2,5,6,10,9,7,8)
  and c.contest_id = cc1.contest_id
  and c.contest_id = cc2.contest_id
  and cc2.property_id = 25
  and cc1.property_id = 28
  and cc1.property_value = ttp.project_id
  and ttp.project_id = ttcp.project_id
  and ttcp.client_id = ttc.client_id
  and ttc.client_id = DECODE(@clientid@, 0, ttc.client_id, @clientid@)
  and ttp.project_id = DECODE(@billingaccountid@, 0, ttp.project_id, @billingaccountid@)
  and c.tc_direct_project_id = tdp.project_id
  and c.tc_direct_project_id = DECODE(@tcdirectid@, 0, tdp.project_id, @tcdirectid@)
  and c.contest_status_id in (1,2,4,10,11)
  and c.contest_status_id = cs.contest_status_id
  and c.contest_detailed_status_id = cds.contest_detailed_status_id
  and c.contest_type_id = cc.contest_type_id
  and cc.contest_type_id IN (@scids@)
  and (pm.create_date BETWEEN TO_DATE('@sdt@ 00:00:00', '%Y-%m-%d %H:%M:%S') AND TO_DATE('@edt@ 23:59:59', '%Y-%m-%d %H:%M:%S'))
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23
order by 1 desc, 2 asc
